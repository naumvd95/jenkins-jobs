- job-template:
    # Upgrade test. Takes base iso, deploys TEST_GROUP snapshot, then
    # runs UPGRADE_TEST_GROUP test on this env.
    #
    # Variables required:
    #
    # version-id
    #     Versioned identificator of the Fuel ISO or tarball used in this job.
    #     For example: ``6.1``, ``6.1-community``, ``6.0-icehouse``.
    # id
    #     Any string, name of the job. Use only [a-z_-] symbols.
    # dist
    #     OPENSTACK_RELEASE variable. 'centos' or 'ubuntu'.
    # testgroup
    #     Initial test group. It is used for base deployment.
    # upgrade_testgroup
    #     Test group for upgrade test. Upgrade tarball will be used.
    # description
    #     Job description.
    # node
    #     Jenkins slave label.
    # timeout
    #     Job timeout.
    # base_iso_magnet_link
    #     Magnet link for base iso.
    # base_repobranch
    #     Branch of the fuel-main/ repo, used for base deployment stage.
    # upgrade_repobranch
    #     Branch of the fuel-main/ repo, used for running upgrade test.
    # weight
    #     Job weight
    name: '{version-id}.{id}.{dist}.test.upgrade.chain'
    block-downstream: false
    block-upstream: false
    builders:
    - inject:
        properties-content: |
          VENV_PATH={base_venv_path}
          OLD_DEVOPS_DB={old_devops_db}
    - inject: # overrides
        properties-content: '{properties}'
    - shell:
        !include-raw-escape 'builders/run_upgradechain_system_test.sh'

    concurrent: true
    description:
      !include-raw descriptions/upgradechain_tests
    disabled: false
    logrotate:
      artifactDaysToKeep: -1
      artifactNumToKeep: -1
      daysToKeep: 30
      numToKeep: 50
    node: '{node}'

    parameters:
    - string:
        name: BASE_ISO_MAGNET_LINK
        default: '{base_iso_magnet_link}'
        description: "Base iso magnet link"
    - string:
        name: BASE_UPGRADE_TARBALL_MAGNET_LINK
        default: '{base_upgrade_tarball_magnet_link}'
        description: ""
    - string:
        name: UPGRADE_TARBALL_MAGNET_LINK
        description: "Upgrade tarball magnet link"
    - string:
        name: OPENSTACK_RELEASE
        default: '{dist}'
        description: Base distribution
    - string:
        name: ENV_PREFIX
        default: '{version-id}.{id}.{dist}.test.upgrade.chain'

    properties:
    - heavy-job:
        weight: '{weight}'

    publishers:
    - archive:
        allow-empty: true
        artifacts: '**/nosetests.xml,*/logs/*'
        latest-only: false
    - junit:
        keep-long-stdio: false
        results: '**/nosetests.xml'
    - description-setter:
        regexp: "'Description string: (.*)'"
        regexp-for-failed: "'Description string: (.*)'"

    scm:
    - main-git:
        reponame: '{base_reponame}'
        repobranch: '{base_repobranch}'
        basedir: 'BASE'
    - main-git:
        reponame: '{base_upgraded_reponame}'
        repobranch: '{base_upgraded_repobranch}'
        basedir: 'BASE_UPGRADED'
    - main-git:
        reponame: '{upgrade_reponame}'
        repobranch: '{upgrade_repobranch}'
        basedir: 'UPGRADE'

    wrappers:
    - timeout:
        fail: false
        timeout: '{timeout}'
        write-description: true
    - ansicolor:
        colormap: xterm
