- builder:                                 
    name: 'runner-builder'                 
    builders:                              
      - copyartifact:                      
          project: 'download_iso'          
          filter: '*.txt'                  
          which-build: 'last-successful'   
      - inject:                            
          properties-file: latest_isos.txt 
      - inject:                            
          properties-file: iso_version.txt 

# jobs for test-group
- defaults:
    name: global
    disabled: true
    logrotate:
        daysToKeep: 7
        numToKeep: 10
        artifactDaysToKeep: 7  
        artifactNumToKeep: 10 

    properties:
      - heavy-job:
          weight: 1

    parameters:
      - string:
          name: ISO_FILE
          default: ''
          description: "The fuel iso name, downloded by the 'download_iso' job to tpi-s1 storage"
      - bool:
          name: USE_SNAPSHOTS
          default: true
          descrition: 'Will be used existing environment'
      - bool:
          name: SHUTDOWN_AFTER
          default: true
          decsription: 'The env will be powered off after test'
      - bool:
          name: ERASE_AFTER
          default: false
          description: 'The env will be erased after test'
    wrappers:
      - ansicolor: 
          colormap: xterm
      - timeout:
          fail: true
          timeout: 6000
- project:
   fuel-release: '8.0'
   name: '{fuel-release}.vcenter.systest'
   description: '{fuel-release} vcenter system tests'
   id: 'systest'
   repobranch: 'origin/master'
   reponame: 'fuel-qa'
   repourl: 'https://github.com/stackforge/{reponame}.git' 
   venvpath: '/home/jenkins/venv-nailgun-tests-2.9'
   systest-name: '{fuel-release}.vcenter.{id}.runner'   
   custom-name: '{fuel-release}.vcenter.{id}.custom'   
#  download-name: '{fuel-release}.download'
   smoke-bvt-name: '{fuel-release}.vcenter.smoke-bvt.runner'

   systest-props-file: 'properties'
   smoke-bvt-props-file: 'properties'
#  download-props-file: 'properties'    

   mail-to: 'rkhozinov@mirantis.com'

   nodes-count: '9'
   admin-node-memory: 4096
   slave-node-memory: 4096
   admin-node-cpu: 4
   slave-node-cpu: 4
   openstack-release: 'Ubuntu'
   vcenter-snapshot: 'vcenterha'
   iso-storage: '/storage/downloads'
   env-prefix: '{fuel-release}.vcenter'

   testgroup:
       - vcenter_smoke
       - vcenter_bvt
       - vcenter_add_delete_nodes
#       - vcenter_cindervmdk
#       - vcenter_computevmware
#       - vcenter_cindervmdk_and_computevmware
#       - vcenter_glance_backend
#       - vcenter_multiple_cluster_with_computevmware
#       - vcenter_ceph
#       - vcenter_computevmware_and_ceph
#       - vcenter_multiroles_cindervmdk_and_ceph
#       - vcenter_multiroles_cindervmdk_and_cinder
#       - vcenter_ceilometer
#       - vcenter_ceilometer_and_computevmware
#       - vcenter_multiroles_ceilometer
#       - vcenter_delete_controler
#       - vcenter_ha_ceph
#       - vcenter_ha_cinder_and_ceph
#       - vcenter_ha_glance_backend_multiple_cluster
#       - vcenter_ha_multiroles_cindervmdk_and_ceph
#       - vcenter_ha_multiroles_cindervmdk_and_cinder
#       - vcenter_ha_nova_flat_multiple_clusters
#       - vcenter_ha_nova_vlan_multiple_clusters
   jobs:
     - '{systest-name}'
     - '{fuel-release}.{id}.{testgroup}'
     - '{smoke-bvt-name}'
     - '{custom-name}'

- job-template:
    name: '{fuel-release}.{id}.{testgroup}'
    concurrent: false
    node: 'vsphere'
    properties:
      - throttle:
          max-per-node: 0
          max-total: 0
          categories:
            - vsphere
            - dvs
            - nsx
          option: category
    scm:       
      - git:
          url: '{repourl}'
          branches: 
            - '{repobranch}' 
    builders:
      - inject:
          properties-content: |
              NODES_COUNT={nodes-count}
              ADMIN_NODE_MEMORY={admin-node-memory}
              SLAVE_NODE_MEMORY={slave-node-memory}
              ADMIN_NODE_CPU={admin-node-cpu} 
              SLAVE_NODE_CPU={slave-node-cpu}
              VENV_PATH={venvpath}
              FUEL_RELEASE={fuel-release}
              OPENSTACK_RELEASE={openstack-release}
              ENV_PREFIX={env-prefix}
              VCENTER_SNAPSHOT={vcenter-snapshot}
              ISO_STORAGE={iso-storage}
              TEST_GROUP={testgroup}
              ENV_NAME=''
      - shell:
          !include-raw-escape builders/systest.vcenter.prepare.sh
      - shell:
          !include-raw-escape builders/systest.vcenter.sh
    publishers:
      - description-setter:
          description: 'release: $fuel_release, build: $iso_version'
          description-for-failed: 'release: $fuel_release, build: $iso_version'
      - xunit:
          types:
            - junit:
                pattern: '**/nosetest.xml'
                skip-if-no-test-files: true

- job-template:
    name: '{custom-name}'
    concurrent: true
    node: 'vsphere'
    parameters:
      - string:
          name: ISO_FILE
          descrition: 'You must define iso file. Our storage for iso: {iso-storage}'
      - string:
          name: TEST_GROUP
          description: 'Enter the name of the test group'
      - bool:
          name: USE_SNAPSHOTS
          default: true
          descrition: 'Will be used existing environment'
      - bool:
          name: MAKE_SNAPSHOT
          default: false
      - bool:
          name: SHUTDOWN_AFTER
          default: true
          decsription: 'The env will be powered off after test'
      - bool:
          name: ERASE_AFTER
          default: false
          description: 'The env will be erased after test'
      - string:
          name: FUEL_QA_COMMIT
          default: 'master'
      - string:
          name: FUEL_QA_GERRIT_COMMIT
          default: ''
          description: 'Refspecs for commits in fuel-qa gerrit separated with spaces. For example, refs/changes/10/55310/1 refs/changes/10/55310/2'
      - string:
          name: ENV_PREFIX
          default: '{env-prefix}'
          description: 'Define env prefix name. This parameter should not be changed'

    properties:
      - throttle:
          max-per-node: 0
          max-total: 0
          categories:
            - vsphere
            - dvs
            - nsx
          option: category
    scm:       
      - git:
          url: '{repourl}'
          branches: 
            - 'origin/$FUEL_QA_COMMIT'
    builders:
      - inject:
          properties-content: |
              NODES_COUNT={nodes-count}
              ADMIN_NODE_MEMORY={admin-node-memory}
              SLAVE_NODE_MEMORY={slave-node-memory}
              ADMIN_NODE_CPU={admin-node-cpu} 
              SLAVE_NODE_CPU={slave-node-cpu}
              VENV_PATH={venvpath}
              FUEL_RELEASE={fuel-release}
              OPENSTACK_RELEASE={openstack-release}
              VCENTER_SNAPSHOT={vcenter-snapshot}
              ISO_STORAGE={iso-storage}
      - shell:
          !include-raw-escape builders/systest.vcenter.prepare.sh
      - shell:
          !include-raw-escape builders/systest.vcenter.custom.sh
    publishers:
      - description-setter:
          description: 'release: $fuel_release, build: $iso_version'
          description-for-failed: 'release: $fuel_release, build: $iso_version'
      - xunit:
          types:
            - junit:
                pattern: '**/nosetest.xml'
                skip-if-no-test-files: true

- job-template:
    name: '{systest-name}'
    description: "System tests for vcenter feature"
    project-type: multijob
    node: runner    
    triggers:
        - timed: 'H 19  * * *'
    builders:
      - runner-builder
      - inject: 
          properties-content: |
              properties_file={systest-props-file}
      - shell:
          !include-raw-escape builders/systest.vcenter.runner.sh
      - multijob:
          name: 'System tests for vcenter'
          condition: COMPLETED
          projects:
            - name: '{fuel-release}.{id}.vcenter_add_delete_nodes'
              current-parameters: true
              property-file: '{systest-props-file}'
              kill-phase-on: NEVER

#            - name: '8.0.systest.vcenter_cindervmdk'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_computevmware'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_cindervmdk_and_computevmware'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_glance_backend'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_multiple_cluster_with_computevmware'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ceph'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_computevmware_and_ceph'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_multiroles_cindervmdk_and_ceph'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_multiroles_cindervmdk_and_cinder'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ceilometer'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ceilometer_and_computevmware'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_multiroles_ceilometer'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_add_delete_nodes'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_delete_controler'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_ceph'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_cinder_and_ceph'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_glance_backend_multiple_cluster'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_multiroles_cindervmdk_and_ceph'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_multiroles_cindervmdk_and_cinder'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_nova_flat_multiple_clusters'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER
#
#            - name: '8.0.systest.vcenter_ha_nova_vlan_multiple_clusters'
#              current-parameters: true
#              property-file: '{systest-props-file}'
#              kill-phase-on: NEVER

    publishers:
      - archive:
          artifacts: '**/nosetests.xml,logs/*'
          allow-empty: true
          fingerprint: true
      - xunit:
          types:
            - junit:
                pattern: '**/nosetest.xml'
                skip-if-no-test-files: true
      - email: 
          recipients: '{mail-to}'

- job-template:
    name: '{smoke-bvt-name}'
    project-type: multijob
    description: "Smoke/BVT tests for vcenter feature per fuel-build"
    node: runner    
    triggers:
        - reverse:
            jobs: 'download_iso'
            result: 'success'
    builders:
      - runner-builder
      - inject: 
          properties-content: |
              properties_file={smoke-bvt-props-file}
      - shell:
          !include-raw-escape builders/systest.vcenter.runner.sh
      - multijob:
          name: 'Smoke/BVT tests for vcenter'
          condition: COMPLETED
          projects:
            - name: '{fuel-release}.{id}.vcenter_smoke'
              current-parameters: true
              property-file: '{smoke-bvt-props-file}'
              kill-phase-on: NEVER
              enable-condition: '"${{ISO_VERSION}}" == "{fuel-release}"' 

            - name: '{fuel-release}.{id}.vcenter_bvt'
              current-parameters: true
              property-file: '{smoke-bvt-props-file}'
              kill-phase-on: NEVER
              enable-condition: '"${{ISO_VERSION}}" == "{fuel-release}"' 

    publishers:
        - archive:
            artifacts: '**/nosetests.xml,logs/*'
            allow-empty: true
            fingerprint: true
        - xunit:
            types:
              - junit:
                  pattern: '**/nosetest.xml'
                  skip-if-no-test-files: true
        - email: 
            recipients: '{mail-to}'

#- job-template:
#    name: '{download-name}'
#    project-type: freestyle
#    node: runner 
#    concurrent: true
#    parameters:
#      - string: 
#          name: RELEASE 
#          default: '{fuel-release}' 
#    builders:
#      - inject:  
#          properties-content: |
#              properties_file={download-props-file}
#              ISO_FILE=''
#      - shell:
#          !include-raw-escape builders/download.sh
#    publishers:
#      - archive:
#          artifacts: '{download-props-file}'
#          allow-empty: true
#          fingerprint: true
#      - email: 
#          recipients: '{mail-to}'
#      - description-setter:
#          description: 'iso: $ISO_FILE'
#          description-for-failed: 'iso: $ISO_FILE'
