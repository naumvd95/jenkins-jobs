- parameter:
    name: common-parameters
    parameters:
      - bool:
          name: PUBLISH_RESULTS
          default: '{obj:publish_results}'
          description: 'Reports results to testrail'
      - bool:
          name: DEBUG
          default: '{debug}'
          description: "Set -x (xtrace) for jobs' bash scripts"
      - bool:
          name: DISABLE_SSL
          default: '{disable_ssl}'
          description: "Disable ssh for openstack horizon"
      - bool:
          name: FORCE_ERASE
          default: '{force_erase}'
          description: "Erase all envs before test"
      - bool:
          name: RECREATE_VENV
          default: '{recreate_venv}'
          description: "Recreate virtual environemnt before tests"
      - bool:
          name: USE_SNAPSHOTS
          default: '{use_snapshots}'
          descrition: 'Will be used existing environment'
      - string:
          name: ISO_FILE
          default: '{iso_file}'
          description: 'ISO file name that is on the tpi-s1 in /storage/downloads'
      - string:
          name: ISO_STORAGE
          default: '/storage/downloads'
          description: 'Storage for iso files'
      - string:
          name: GERRIT_REFSPEC
          default: 'refs/heads/{gerrit-branch}'
          description: 'Refspecs for commits in fuel-qa gerrit separated with spaces'
      - string:
          name: GERRIT_BRANCH
          default: 'origin/{gerrit-branch}'
          description: 'The branch for fuel-qa gerrit'
      - string:
          name: PKG_JOB_NAME
          default: '{pkg_job_name}'
          description: 'The name of job for copying of plugin pkg artefacts'
      - string:
          name: PKG_JOB_BUILD_NUMBER
          description: 'The name of job for copying of plugin pkg artefacts'
      - string:
          name: ISO_JOB_NAME
          default: '{iso_job_name}'
          description: 'The name of job for copying of stable iso build name'
      - string:
          name: ENV_PREFIX
          default: '{env_prefix}'
          description: 'The name of devops env. Needed to properly work of existing mode of devops'
      - string:
          name: TREP_TESTRAIL_SUITE
          default: '{testrail_suite}'
          description: 'The test suite name, ex.[8.0][PCE] vCenter Smoke/BVT'
      - string:
          name: TREP_TESTRAIL_SUITE_DESCRIPTION
          default: '{testrail_suite_desc}'
          description: 'Testrail suite description'
      - string:
          name: TREP_TESTRAIL_PLAN
          default: '{testrail_plan}'
          description: 'Testrail testplan name'
      - string:
          name: TREP_TESTRAIL_PLAN_DESCRIPTION
          default: '{testrail_plan_desc}'
          description: 'Testrail testplan description'
      - string:
          name: OPENSTACK_RELEASE
          default: 'Ubuntu'
          description: 'Openstack release (CentOS, Ubuntu)'
      - string:
          name: NODES_COUNT
          default: '10'
          description: 'Amount of nodes in the test lab'
      - string:
          name: ADMIN_NODE_MEMORY
          default: '{admin_node_memory}'
          description: 'Amount of vitrual RAM for admin node'
      - string:
          name: SLAVE_NODE_MEMORY
          default: '{slave_node_memory}'
          description: 'Amount of vitrual RAM per slave node'
      - string:
          name: ADMIN_NODE_CPU
          default: '{admin_node_cpu}'
          description: 'Amount of vitrual CPUs for admin node'
      - string:
          name: SLAVE_NODE_CPU
          default: '{slave_node_cpu}'
          description: 'Amount of vitrual CPUs per slave node'

- publisher:
    name: runner-publisher
    publishers:
      - postbuildscript:
          script-only-if-succeeded: False
          builders:
            - shell: env > {properties_name}
      - archive:
          artifacts: '*properties'
          allow-empty: true
      - archive:
          artifacts: 'iso_file'
          allow-empty: true
      - archive:
          artifacts: 'build.plugin_version'
          allow-empty: true
      - email:
          recipients: '{email-to}'

- builder:
    name: runner-condition
    builders:
      - conditional-step:
          condition-kind: shell
          condition-command: |
            #!/bin/bash -xe
            if [[ ${MJ_BUILD_PKG}=="true" ]]; then
              if [ -z ${PKG_JOB_BUILD_NUMBER} ]; then
                echo "Plugin will be built"
              else
                echo "Plugin won't be built"
                exit 1
              fi
            esle
              echo "Plugin won't be built"
              exit 1
            fi
          steps:
            - trigger-builds:
                - project: ${PKG_JOB_NAME}
                  current-parameters: false
                  git-revision: false
                  block: true
      - conditional-step:
          condition-kind: shell
          condition-command: >
            [ -z  ${PKG_JOB_BUILD_NUMBER} ]
          steps:
            - copyartifact:
                project: ${PKG_JOB_NAME}
                filter: "build.properties"
                which-build: last-successful
      - conditional-step:
          condition-kind: shell
          condition-command: >
            [ ! -z ${PKG_JOB_BUILD_NUMBER} ]
          steps:
            - copyartifact:
                project: ${PKG_JOB_NAME}
                filter: "build.properties"
                which-build: specific-build
                build-number: ${PKG_JOB_BUILD_NUMBER}
      - conditional-step:
          condition-kind: file-exists
          condition-filename: "build.properties"
          steps:
            - shell: |
                #!/bin/bash
                build_number=$(grep "BUILD_NUMBER" < build.properties | cut -d= -f2)
                echo "PKG_JOB_BUILD_NUMBER=$build_number" > build_number
      - conditional-step:
          condition-kind: shell
          condition-command: >
            [ -z ${ISO_FILE} ]
          steps:
            - copyartifact:
                project: ${ISO_JOB_NAME}
                filter: "iso_file"
                which-build: last-successful

# common git settings to get sources
- scm:
    name: common-scm
    scm:
      - git:
          url: 'https://review.openstack.org/openstack/{gerrit-repo}'
          refspec: $GERRIT_REFSPEC
          branches:
            - $GERRIT_BRANCH
          choosing-strategy: gerrit
          skip-tag: true
          submodule:
            disable: '{obj:scm_submodule_disabled}'
            tracking: true
            recursive: true
          wipe-workspace: false

- trigger:
    name: generic-gerrit-trigger
    triggers:
      - gerrit:
         trigger-on: '{obj:trigger_on}'
         projects:
           - project-compare-type: 'PLAIN'
             project-pattern: 'openstack/{gerrit-repo}'
             branches:
               - branch-compare-type: 'ANT'
                 branch-pattern: '{gerrit-branch}'
             forbidden-file-paths:
               - compare-type: 'ANT'
                 pattern: 'docs/**'
               - compare-type: 'ANT'
                 pattern: 'specs/**'
         silent: false
         override-votes: true
         server-name: 'review.openstack.org'
         custom-url: '* $JOB_NAME $BUILD_URL'
         escape-quotes: true
         readable-message: true
         skip-vote:
           successfull: false
           failed: false
           unstable: true
           notbuilt: true

# build and smoke should trigger on patchset event               
- trigger:
    name: draft-patchset-gerrit-trigger
    triggers:
      - generic-gerrit-trigger:
          gerrit-repo: '{gerrit-repo}'
          gerrit-branch: '{gerrit-branch}'
          trigger_on:
            - draft-published-event
            - patchset-created-event:
                exclude-trivial-rebase: true
                exclude-no-code-change: true

# bvt should trigger on merge event     
- trigger:
    name: merge-gerrit-trigger
    triggers:
      - generic-gerrit-trigger:
          gerrit-repo: '{gerrit-repo}'
          gerrit-branch: '{gerrit-branch}'
          trigger_on:
            - change-merged-event


# properties for smoke, bvt and nightly multijobs
- wrapper:
    name: runner-wrapper
    wrappers:
      - ansicolor:
          colormap: xterm

# properties for smoke, bvt and nightly multijobs
- wrapper:
    name: test-wrapper
    wrappers:
      - ansicolor:
          colormap: xterm
      - inject-passwords:
          global: true
          mask-password-params: true
      - timeout:
          fail: true
          type: no-activity
          write-description: "Timeout is exceeded"
          timeout: '{test-timeout}'

- property:
    name: runner-property
    properties:
      - heavy-job:
          weight: 1
      - build-blocker:
          use-build-blocker: true
          blocking-jobs:
            - '{build-name}'
          block-level: 'GLOBAL'
          queue-scanning: 'BUILDABLE'

# properties for test jobs
- property:
    name: test-property
    properties:
      - heavy-job:
          weight: 1
      - throttle:
          max-per-node: 0
          max-total: 0
          enabled: true
          categories:
            - vcenter
            - dvs
            - nsxv
            - contrail
            - lma
            - elasticsearch
            - influxdb
          option: category
