---
- project:
    name: 'utilites'        
    download_iso: 'download_iso'
    sync_jira_with_launchpad: 'sync_jira_with_launchpad'
    clean_envs: 'clean_envs'
    puppet_run: 'puppet_run'
    contrail_rst_upload_name: 'contrail_rst_upload'
#    contrail-tempest: 'contrail-tempest'
    jobs:
      - '{download_iso}'

      - '{sync_jira_with_launchpad}'

      - '{clean_envs}'

      - '{puppet_run}'

      - '{contrail_rst_upload_name}'

        #      - '{contrail-tempest}'
      
- job-template:
    name: '{download_iso}'
    node: 'download_iso'
    concurrent: true
    disabled: false
    parameters:
      - string:
          name: RELEASE
          default: '9.0-mos'
    properties:
      - heavy-job:
          weight: 1
    wrappers:
      - ansicolor:
          colormap: xterm
    builders:
      - copyartifact:
          project: "{download_iso}"
          which-build: last-successful
          fingerprint: true
      - shell:
          !include-raw-escape: ../builders/build-job-download-iso.sh
    publishers:
      - archive:
          artifacts: '*.txt, iso_file, iso_version'
      - description-setter:
          regexp: "ISO_FILE=.*"
      - email:
          recipients: rkhozinov@mirantis.com
          notify-every-unstable-build: true
                  
- job-template:
    name: '{sync_jira_with_launchpad}'
    node: 'runner'
    concurrent: false
    disabled: false
    triggers:
      - timed: "H 5-18/3 * * 1-5"
    scm:
      - git:
          url: $URL
          branches:
            - $BRANCH
    wrappers:
      - inject-passwords:
          global: true
          mask-password-params: true
      - ansicolor:
          colormap: xterm
    parameters:
      - string:
          name: JIRA_URL
          default: 'https://mirantis.jira.com/'
      - string:
          name: JIRA_PROJECT
          default: 'FPL'
      - string:
          name: LAUNCHPAD_TEAM
          default: 'fuel-partner-engineering'
      - string:
          name: URL
          default: 'https://github.com/ibumarskov/qa_reports.git'
          description: "url for git repo"
      - string:
          name: BRANCH
          default: '*/master'
          description: "default branch for git repo"    
    properties:
      - heavy-job:
          weight: 1
    builders:
      - shell:
          !include-raw-escape: ../builders/build-job-sync-jira-with-launchpad.sh

- job-template:
    name: '{clean_envs}'
    concurrent: false
    disabled: false
    wrappers:
      - ansicolor:
          colormap: xterm
    parameters:
      - label:
          name: node
          description: "set plugin-label, PAY ATTENTION, checker Run on all 'nodes matching the label' must be enabled in configure tab"
      - string:
          name: FUEL_RELEASE_NUMBER
          default: '90'
          description: "set number of active venv, as example = '90' for 90-venv, default= '90' ; all cases = 90,80,70,61"
    properties:
      - test-property
    builders:
      - shell:
          !include-raw-escape: ../builders/build-job-clean-envs.sh

- job-template:
    name: '{puppet_run}'
    concurrent: false
    disabled: false
    wrappers:
      - ansicolor:
          colormap: xterm
    parameters:
      - label:
          name: node
          description: "set plugin-label, PAY ATTENTION, checker Run on all 'nodes matching the label' must be enabled in configure tab"
    properties:
      - test-property
    builders:
      - shell: |
          sudo pkill vmx || echo  'virtual machines are killed'
          if sudo puppet agent -tdv --server tpi-puppet.vm.mirantis.net --waitforcert 30;  then
              echo "Command succeeded"
          else
              ref=$?
              if [ "$ref" == "1" ]; then
                echo "Some packages,libraries failed to load on lab ${HOSTNAME}"
              else
                echo "result in acceptable limits ( exit code = $ref )"
              fi
          fi 

- scm:
    name: contrail-repo-scm
    scm:
      - git:
         url: https://github.com/openstack/fuel-plugin-contrail
         branches:
          - origin/master
         basedir: ${WORKSPACE}/contrail-repo

- scm:
    name: contrail-utility-scm
    scm:
      - git:
         url: https://github.com/ehles/rst2tr
         branches:
          - origin/master
         basedir: ${WORKSPACE}/utility-repo
- scm:
    name: contrail-utility
    scm:
      - contrail-repo-scm
      - contrail-utility-scm

- defaults:
    name: global
    disabled: false
    node: runner
    scm:
      - contrail-utility
- job-template:
    name: '{contrail_rst_upload_name}'
    node: 'runner'
    concurrent: false
    disabled: false
    scm:
      - contrail-utility
    wrappers:
      - inject-passwords:
          global: true
          mask-password-params: true
      - ansicolor:
          colormap: xterm
    triggers:
      - pollscm:
          cron: ""
    parameters:
      - bool:
          name: CHECK_ONLY
          default: true
          description: "check documentation format without commiting"
      - bool:
          name: MODERN_MODEL
          default: false
          description: "enable use modern-testing-model, default = classic-testing-model"
      - string:
          name: TESTRAIL_URL
          default: "https://mirantis.testrail.com"
      - string:
          name: TESTRAIL_USER
          default: ""
      - string:
          name: TESTRAIL_API_KEY
          default: ""
      - string: 
          name: TESTRAIL_PROJECT
          default: "Contrail plugin"
      - string:
          name: TESTRAIL_MILESTONE
          default: "Fuel Contrail Plugin v5.0.0"
      - string:
          name: TESTRAIL_SUITE
          default: "[9.0][PCE] Fuel plugin contrail v5.0.0 nightly"
      - string:
          name: TESTRAIL_CUSTOM_QA_TEAM
          default: "6"
      - bool:
          name: TESTRAIL_CREATE_SECTION
          default: true
    builders:
      - shell:
          !include-raw-escape: ../builders/build-job-rst-testcases-upload.sh


                  
#- job-template:
#    name: '{contrail-tempest}'
#    node: 'contrail'
#    concurrent: false
#    disabled: false
#    scm:
#      - contrail-repo-scm:
#          reponame: https://github.com/openstack/fuel-plugin-contrail
#          repobranch: origin/master
#          basedir: ${{WORKSPACE}}/contrail-repo
#      - contrail-repo-scm:
#          reponame: https://github.com/ehles/rst2tr
#          repobranch: origin/master
#          basedir: ${{WORKSPACE}}/utility-repo
#    wrappers:
#      - inject-passwords:
#          global: true
#          mask-password-params: true
#      - ansicolor:
#          colormap: xterm
#    parameters:
#      - bool:
#          name: CHECK_ONLY
#          default: true
#          description: "check ntation format without commiting"
#      - bool:
#          name: MODERN_MODEL
#          default: false
#          description: "enable use modern-testing-model, default = classic-testing-model"
#      - string:
#          name: TESTRAIL_URL
#          default: "https://mirantis.testrail.com"
#      - string:
#          name: TESTRAIL_USER
#          default: ""
#      - string:
#          name: TESTRAIL_API_KEY
#          default: ""
#      - string: 
#          name: TESTRAIL_PROJECT
#          default: "Contrail plugin"
#      - string:
#          name: TESTRAIL_MILESTONE
#          default: "Fuel Contrail Plugin v5.0.0"
#      - string:
#          name: TESTRAIL_SUITE
#          default: "[9.0][PCE] Fuel plugin contrail v5.0.0 nightly"
#      - string:
#          name: TESTRAIL_CUSTOM_QA_TEAM
#          default: "6"
#      - bool:
#          name: TESTRAIL_CREATE_SECTION
#          default: true
#    builders:
#      - shell:
#          !include-raw-escape: ../builders/build-job-rst-testcases-upload.sh
